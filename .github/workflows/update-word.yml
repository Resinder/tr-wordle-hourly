# Bu workflow, her saat baÅŸÄ± Ã§alÄ±ÅŸÄ±r ve yeni bir kelime seÃ§er.
name: Update Hourly Word

on:
  schedule:
    # Her saat baÅŸÄ±, dakika 0'da Ã§alÄ±ÅŸÄ±r (UTC zamanÄ±na gÃ¶re)
    - cron: '0 * * * *'
  # AyrÄ±ca manuel olarak da tetiklenebilir
  workflow_dispatch:

# Ã–NEMLI: GitHub Actions'a yazma izni vermek iÃ§in
permissions:
  contents: write

jobs:
  update-word:
    runs-on: ubuntu-latest
    steps:
      # 1. Repository'i checkout eder
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      # 2. Git kullanÄ±cÄ±sÄ±nÄ± ayarla
      - name: Setup Git
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      # 3. Node.js ortamÄ±nÄ± kurar
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # 4. Kelimeyi seÃ§en script'i Ã§alÄ±ÅŸtÄ±rÄ±r
      - name: Download word list and select word
        run: |
          echo "ğŸ“¥ Kelime listesi indiriliyor..."
          curl -s -o kelimeler.json "https://gist.githubusercontent.com/Resinder/b2897fd639006e34a1bf54252d730f7b/raw/b29034e404094142bfeb896e7e8e5aa50b6db46f/tdk-5-harfli-kelimeler.json"
          
          echo "ğŸ“Š Ä°ndirilen dosya boyutu:"
          ls -lh kelimeler.json
          
          echo "ğŸ” Ä°lk 3 kelime:"
          head -n 3 kelimeler.json
          
          echo "ğŸ² Rastgele kelime seÃ§iliyor..."
          node << 'EOF'
          const fs = require('fs');
          
          try {
            // Kelime listesini oku
            const kelimelerText = fs.readFileSync('kelimeler.json', 'utf-8');
            const kelimeler = JSON.parse(kelimelerText);
            
            console.log(`ğŸ“š Toplam ${kelimeler.length} kelime bulundu`);
            
            // Rastgele kelime seÃ§
            const rastgeleIndeks = Math.floor(Math.random() * kelimeler.length);
            const secilenKelime = kelimeler[rastgeleIndeks];
            
            // 5 harfli olduÄŸundan emin ol
            if (secilenKelime.length !== 5) {
              console.error(`âŒ Hata: SeÃ§ilen kelime 5 harfli deÄŸil: ${secilenKelime}`);
              process.exit(1);
            }
            
            // JSON dosyasÄ± oluÅŸtur
            const jsonVerisi = { 
              kelime: secilenKelime.toUpperCase(),
              saat: new Date().toISOString(),
              timestamp: Date.now()
            };
            
            fs.writeFileSync('gizli-kelime.json', JSON.stringify(jsonVerisi, null, 2) + '\n');
            
            console.log('âœ… Yeni kelime seÃ§ildi:', secilenKelime.toUpperCase());
            console.log('ğŸ“„ Dosya iÃ§eriÄŸi:');
            console.log(fs.readFileSync('gizli-kelime.json', 'utf-8'));
            
          } catch (error) {
            console.error('âŒ Hata:', error.message);
            process.exit(1);
          }
          EOF
          
          echo "ğŸ§¹ GeÃ§ici dosyayÄ± temizle..."
          rm -f kelimeler.json
          
          echo "âœ… Kelime seÃ§imi tamamlandÄ±!"
      
      # 5. DosyanÄ±n oluÅŸturulduÄŸunu doÄŸrula
      - name: Verify file creation
        run: |
          if [ ! -f gizli-kelime.json ]; then
            echo "âŒ Hata: gizli-kelime.json dosyasÄ± oluÅŸturulmadÄ±!"
            exit 1
          fi
          
          echo "âœ… Dosya mevcut"
          echo "ğŸ“„ Dosya boyutu:"
          ls -lh gizli-kelime.json
          
          echo "ğŸ“ Dosya iÃ§eriÄŸi:"
          cat gizli-kelime.json
          
          echo "ğŸ” JSON geÃ§erliliÄŸi kontrolÃ¼:"
          node -e "console.log(JSON.parse(require('fs').readFileSync('gizli-kelime.json', 'utf-8')))"
      
      # 6. Git durumunu kontrol et
      - name: Check git status
        run: |
          echo "ğŸ“Š Git durumu:"
          git status
          
          echo ""
          echo "ğŸ“ DeÄŸiÅŸiklikler:"
          git diff
      
      # 7. DeÄŸiÅŸiklikleri commit ve push et
      - name: Commit and push changes
        run: |
          # DeÄŸiÅŸiklik olup olmadÄ±ÄŸÄ±nÄ± kontrol et
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ DeÄŸiÅŸiklikler commit ediliyor..."
            
            git add gizli-kelime.json
            git commit -m "ğŸ”„ Saatlik kelime gÃ¼ncellendi - $(date -u +'%Y-%m-%d %H:%M UTC')"
            
            echo "â¬†ï¸ Push yapÄ±lÄ±yor..."
            git push
            
            echo "âœ… BaÅŸarÄ±yla push edildi!"
          else
            echo "â„¹ï¸ DeÄŸiÅŸiklik yok, push atlanÄ±yor."
          fi
      
      # 8. Son kontrolÃ¼ yap
      - name: Final verification
        if: success()
        run: |
          echo "ğŸ‰ Workflow baÅŸarÄ±yla tamamlandÄ±!"
          echo ""
          echo "ğŸ“Š Ã–zet:"
          echo "  - Dosya: gizli-kelime.json"
          echo "  - Boyut: $(stat -f%z gizli-kelime.json 2>/dev/null || stat -c%s gizli-kelime.json) bytes"
          echo "  - Zaman: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âœ… Kelime baÅŸarÄ±yla gÃ¼ncellendi ve push edildi!"
