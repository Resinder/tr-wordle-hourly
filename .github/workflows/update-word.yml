name: ðŸ”„ Saatlik Kelime GÃ¼ncelleyici

on:
  schedule:
    # Her 5 dakikada kontrol eder, saat baÅŸÄ±nda gÃ¼nceller
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Zorla gÃ¼ncelleme yap (aynÄ± saat iÃ§inde bile)'
        required: false
        type: boolean
        default: false

concurrency:
  group: word-update-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write

env:
  GIST_URL: 'https://gist.githubusercontent.com/Resinder/b2897fd639006e34a1bf54252d730f7b/raw/tdk-5-harfli-kelimeler.json'
  WORD_FILE: 'gizli-kelime.json'

jobs:
  update-word:
    name: Kelime GÃ¼ncelle
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Repository Ä°ndir
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: ðŸ”§ Node.js Kur
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸŽ² Yeni Kelime SeÃ§
        id: update_word
        env:
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
        run: |
          node << 'SCRIPT_END'
          const fs = require('fs');
          const { GIST_URL, WORD_FILE } = process.env;
          const FORCE_UPDATE = process.env.FORCE_UPDATE === 'true';

          // Utility fonksiyonlar
          const readJSON = (path) => {
            try {
              return fs.existsSync(path) ? JSON.parse(fs.readFileSync(path, 'utf8')) : null;
            } catch (err) {
              console.warn(`âš ï¸  JSON okuma hatasÄ±: ${err.message}`);
              return null;
            }
          };

          const writeJSON = (path, data) => {
            fs.writeFileSync(path, JSON.stringify(data, null, 2) + '\n', 'utf8');
          };

          const fetchWithRetry = async (url, retries = 3) => {
            for (let i = 0; i < retries; i++) {
              try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
              } catch (err) {
                if (i === retries - 1) throw err;
                console.log(`ðŸ”„ Yeniden deneniyor (${i + 1}/${retries})...`);
                await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
              }
            }
          };

          // Ana iÅŸlem
          (async () => {
            try {
              const now = new Date();
              const currentHourKey = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, '0')}-${String(now.getUTCDate()).padStart(2, '0')}-${String(now.getUTCHours()).padStart(2, '0')}`;
              const humanReadable = now.toISOString().replace('T', ' ').substring(0, 13) + ':00 UTC';

              console.log(`\nâ° Åžu anki saat: ${humanReadable}`);
              console.log(`ðŸ”‘ Hour Key: ${currentHourKey}\n`);

              // Mevcut veriyi oku
              const currentData = readJSON(WORD_FILE) || { kelime: '', hourKey: '' };

              // Zaten gÃ¼ncellenmiÅŸ mi kontrol et
              if (!FORCE_UPDATE && currentData.hourKey === currentHourKey) {
                console.log(`âœ… ${humanReadable} iÃ§in kelime zaten gÃ¼ncellenmiÅŸ`);
                console.log(`ðŸ“ Mevcut kelime: ${currentData.kelime}\n`);
                process.exit(0);
              }

              if (FORCE_UPDATE) {
                console.log('âš¡ Zorla gÃ¼ncelleme modu aktif\n');
              }

              // Kelime listesini indir
              console.log('ðŸ“¡ Kelime listesi indiriliyor...');
              const kelimeler = await fetchWithRetry(GIST_URL);
              
              if (!Array.isArray(kelimeler) || kelimeler.length === 0) {
                throw new Error('Kelime listesi boÅŸ veya geÃ§ersiz');
              }

              console.log(`ðŸ“š ${kelimeler.length} kelime yÃ¼klendi\n`);

              // Rastgele yeni kelime seÃ§ (Ã¶ncekinden farklÄ±)
              let yeniKelime;
              let attempts = 0;
              const maxAttempts = 10;

              do {
                yeniKelime = kelimeler[Math.floor(Math.random() * kelimeler.length)]
                  .toLocaleUpperCase('tr-TR');
                attempts++;
              } while (
                yeniKelime === currentData.kelime && 
                kelimeler.length > 1 && 
                attempts < maxAttempts
              );

              // Yeni veriyi kaydet
              const newData = {
                kelime: yeniKelime,
                saat: now.toISOString(),
                hourKey: currentHourKey,
                timestamp: now.getTime(),
                oncekiKelime: currentData.kelime || null
              };

              writeJSON(WORD_FILE, newData);

              console.log('âœ¨ GÃ¼ncelleme baÅŸarÄ±lÄ±!');
              console.log(`ðŸ“ Yeni kelime: ${yeniKelime}`);
              if (currentData.kelime) {
                console.log(`ðŸ“‹ Ã–nceki kelime: ${currentData.kelime}`);
              }
              console.log('');

              // GitHub Actions output
              console.log(`::set-output name=word::${yeniKelime}`);
              console.log(`::set-output name=changed::true`);

            } catch (err) {
              console.error('\nâŒ Hata:', err.message);
              console.error(err.stack);
              process.exit(1);
            }
          })();
          SCRIPT_END

      - name: ðŸ’¾ DeÄŸiÅŸiklikleri Kaydet
        id: commit
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          git add "$WORD_FILE"
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸  DeÄŸiÅŸiklik yok, commit atlanÄ±yor"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          COMMIT_MSG="ðŸ”„ Kelime gÃ¼ncellendi: $(date -u +'%Y-%m-%d %H:00 UTC')"
          
          git commit -m "$COMMIT_MSG"
          git pull --rebase origin main || true
          git push origin main
          
          echo "âœ… DeÄŸiÅŸiklikler push edildi"
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ GitHub Pages HazÄ±rla
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/configure-pages@v4

      - name: ðŸ“¤ Artifact YÃ¼kle
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: ðŸš€ GitHub Pages Deploy
        if: steps.commit.outputs.has_changes == 'true'
        id: deploy
        uses: actions/deploy-pages@v4

      - name: ðŸ“Š Ã–zet
        if: always()
        run: |
          echo "## ðŸ“ˆ Ã‡alÄ±ÅŸtÄ±rma Ã–zeti" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tarih:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Tetikleyici:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.commit.outputs.has_changes }}" == "true" ]; then
            echo "- **Durum:** âœ… Kelime gÃ¼ncellendi ve deploy edildi" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.update_word.outputs.word }}" ]; then
              echo "- **Yeni Kelime:** ${{ steps.update_word.outputs.word }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Durum:** â„¹ï¸  GÃ¼ncelleme gerekmedi" >> $GITHUB_STEP_SUMMARY
          fi
