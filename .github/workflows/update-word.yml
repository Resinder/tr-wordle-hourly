name: ðŸ”„ Saatlik Kelime GÃ¼ncelleyici

on:
  schedule:
    # Her 5 dakikada kontrol eder, saat baÅŸÄ±nda gÃ¼nceller
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Zorla gÃ¼ncelleme yap'
        required: false
        type: boolean
        default: false

concurrency:
  group: word-update
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-word:
    name: Kelime GÃ¼ncelle ve Deploy Et
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ðŸŽ² Yeni Kelime SeÃ§
        id: update
        env:
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          
          const GIST_URL = 'https://gist.githubusercontent.com/Resinder/b2897fd639006e34a1bf54252d730f7b/raw/tdk-5-harfli-kelimeler.json';
          const FILE = 'gizli-kelime.json';
          const FORCE = process.env.FORCE_UPDATE === 'true';
          
          const readJSON = (path) => {
            try {
              return fs.existsSync(path) ? JSON.parse(fs.readFileSync(path, 'utf8')) : {};
            } catch { return {}; }
          };
          
          const fetchRetry = async (url, retries = 3) => {
            for (let i = 0; i < retries; i++) {
              try {
                const res = await fetch(url);
                if (res.ok) return await res.json();
              } catch (err) {
                if (i === retries - 1) throw err;
                await new Promise(r => setTimeout(r, 1000));
              }
            }
          };
          
          (async () => {
            try {
              const now = new Date();
              const hourKey = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, '0')}-${String(now.getUTCDate()).padStart(2, '0')}-${String(now.getUTCHours()).padStart(2, '0')}`;
              const timeStr = now.toISOString().slice(0, 13) + ':00 UTC';
              
              console.log(`â° ${timeStr}`);
              
              const current = readJSON(FILE);
              
              if (!FORCE && current.hourKey === hourKey) {
                console.log(`âœ… Kelime zaten gÃ¼ncel: ${current.kelime}`);
                process.exit(0);
              }
              
              if (FORCE) console.log('âš¡ Zorla gÃ¼ncelleme');
              
              console.log('ðŸ“¡ Kelime listesi indiriliyor...');
              const words = await fetchRetry(GIST_URL);
              
              if (!Array.isArray(words) || words.length === 0) {
                throw new Error('Kelime listesi boÅŸ');
              }
              
              console.log(`ðŸ“š ${words.length} kelime yÃ¼klendi`);
              
              let newWord;
              let attempts = 0;
              do {
                newWord = words[Math.floor(Math.random() * words.length)].toLocaleUpperCase('tr-TR');
                attempts++;
              } while (newWord === current.kelime && words.length > 1 && attempts < 10);
              
              const data = {
                kelime: newWord,
                saat: now.toISOString(),
                hourKey: hourKey,
                timestamp: now.getTime()
              };
              
              fs.writeFileSync(FILE, JSON.stringify(data, null, 2) + '\n');
              
              console.log(`âœ¨ Yeni kelime: ${newWord}`);
              if (current.kelime) console.log(`ðŸ“‹ Ã–nceki: ${current.kelime}`);
              
            } catch (err) {
              console.error('âŒ Hata:', err.message);
              process.exit(1);
            }
          })();
          EOF

      - name: ðŸ’¾ Commit & Push
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add gizli-kelime.json
          
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  DeÄŸiÅŸiklik yok"
            exit 0
          fi
          
          git commit -m "ðŸ”„ $(date -u +'%Y-%m-%d %H:00 UTC')"
          git pull --rebase origin main || true
          git push
          
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Push edildi"

      - name: ðŸš€ GitHub Pages Deploy
        if: steps.commit.outputs.changed == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: false

      - name: ðŸ“Š Ã–zet
        if: always()
        run: |
          echo "## ðŸ“ˆ Ã–zet" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Zaman:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Tetikleyici:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.commit.outputs.changed }}" == "true" ]; then
            echo "- **Durum:** âœ… GÃ¼ncellendi ve deploy edildi" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Durum:** â„¹ï¸  GÃ¼ncelleme gerekmedi" >> $GITHUB_STEP_SUMMARY
          fi
