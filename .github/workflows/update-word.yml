name: Hourly Word (Reliable Update) & Deploy

on:
  schedule:
    # GitHub gecikmelerini kompanse etmek iÃ§in her 5 dakikada bir kontrol et
    - cron: '*/5 * * * *'
  workflow_dispatch:

concurrency:
  group: "word-update"
  cancel-in-progress: false # Devam eden sÃ¼reci iptal etme, Pages deploy bitsin

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true 

      - name: Process Word Update
        id: process_step
        run: |
          node << 'EOF'
          const fs = require('fs');
          
          async function start() {
            const GIST_URL = "https://gist.githubusercontent.com/Resinder/b2897fd639006e34a1bf54252d730f7b/raw/b29034e404094142bfeb896e7e8e5aa50b6db46f/tdk-5-harfli-kelimeler.json";
            const FILE_NAME = 'gizli-kelime.json';
            
            const now = new Date();
            // UTC yerine yerel saat karmaÅŸasÄ±nÄ± Ã¶nlemek iÃ§in doÄŸrudan saat deÄŸerini alalÄ±m
            const currentHour = now.getUTCHours();
            const currentDate = now.getUTCDate();
            const currentHourKey = `H${currentHour}-D${currentDate}-M${now.getUTCMonth()}`;

            let data = { kelime: "", hourKey: "" };
            if (fs.existsSync(FILE_NAME)) {
              try {
                data = JSON.parse(fs.readFileSync(FILE_NAME, 'utf-8'));
              } catch (e) { console.log("Dosya okunamadÄ±, yeni oluÅŸturuluyor."); }
            }

            // GÃœNCELLEME MANTIÄI: EÄŸer kayÄ±tlÄ± hourKey mevcut saatle aynÄ± DEÄÄ°LSE gÃ¼ncelle
            if (data.hourKey === currentHourKey) {
              console.log(`>>> ${currentHour}:00 UTC kelimesi zaten mevcut. Ä°ÅŸlem durduruldu.`);
              process.exit(0);
            }

            console.log(`>>> ${currentHour}:00 UTC iÃ§in yeni kelime atanÄ±yor...`);

            const response = await fetch(GIST_URL);
            const kelimeler = await response.json();
            
            let yeniKelime;
            do {
              yeniKelime = kelimeler[Math.floor(Math.random() * kelimeler.length)].toUpperCase('tr-TR');
            } while (yeniKelime === data.kelime);

            fs.writeFileSync(FILE_NAME, JSON.stringify({
              kelime: yeniKelime,
              saat: now.toISOString(),
              hourKey: currentHourKey
            }, null, 2));
            
            console.log(`>>> Yeni Kelime: ${yeniKelime}`);
          }
          start();
          EOF

      - name: Commit and Push
        id: commit_step
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add gizli-kelime.json
          
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ”„ Kelime Guncellendi: $(date -u +'%H:00 UTC')"
            git push origin main
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to GitHub Pages
        if: steps.commit_step.outputs.changed == 'true'
        uses: actions/deploy-pages@v4
        # Not: deploy-pages kullanmak iÃ§in Ã¶nce sayfayÄ± build etmeniz veya upload etmeniz gerekir. 
        # Ancak en saÄŸlÄ±klÄ± yol GitHub Pages ayarlarÄ±ndan "Deploy from Branch" seÃ§ip "main"i seÃ§mektir.
