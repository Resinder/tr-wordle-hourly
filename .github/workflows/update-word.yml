name: Update Hourly Word

on:
  schedule:
    - cron: '0 * * * *' # Her saat baÅŸÄ±
  workflow_dispatch: # Manuel tetikleme

permissions:
  contents: write

jobs:
  update-word:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # persist-credentials true varsayÄ±lan olarak gelir, token otomatik yÃ¶netilir

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Select New Word
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');

          const GIST_URL = "https://gist.githubusercontent.com/Resinder/b2897fd639006e34a1bf54252d730f7b/raw/b29034e404094142bfeb896e7e8e5aa50b6db46f/tdk-5-harfli-kelimeler.json";
          const FILE_NAME = 'gizli-kelime.json';

          https.get(GIST_URL, (res) => {
            let data = '';
            res.on('data', (chunk) => data += chunk);
            res.on('end', () => {
              try {
                const kelimeler = JSON.parse(data);
                
                // Mevcut kelimeyi oku (aynÄ±sÄ±nÄ± seÃ§memek iÃ§in)
                let eskiKelime = "";
                if (fs.existsSync(FILE_NAME)) {
                  const currentFile = JSON.parse(fs.readFileSync(FILE_NAME, 'utf-8'));
                  eskiKelime = currentFile.kelime;
                }

                // Yeni kelime seÃ§ (Eskisinden farklÄ± olana kadar)
                let yeniKelime;
                do {
                  const index = Math.floor(Math.random() * kelimeler.length);
                  yeniKelime = kelimeler[index].toUpperCase('tr-TR');
                } while (yeniKelime === eskiKelime && kelimeler.length > 1);

                const output = {
                  kelime: yeniKelime,
                  saat: new Date().toISOString(),
                  timestamp: Date.now()
                };

                fs.writeFileSync(FILE_NAME, JSON.stringify(output, null, 2));
                console.log(`âœ… Eski: ${eskiKelime} -> Yeni: ${yeniKelime}`);
              } catch (e) {
                console.error("Hata:", e.message);
                process.exit(1);
              }
            });
          }).on('error', (err) => {
            console.error("Ä°ndirme HatasÄ±:", err.message);
            process.exit(1);
          });
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add gizli-kelime.json
            git commit -m "ðŸ”„ Kelime GÃ¼ncellendi: $(date -u +'%H:%M UTC')"
            git push
          else
            echo "DeÄŸiÅŸiklik yok."
          fi
